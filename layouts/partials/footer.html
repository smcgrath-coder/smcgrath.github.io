{{- if and (.IsHome) (not (.Param "hideBluesky")) }}
<div class="bluesky-section">
<style>
.bluesky-section {
  max-width: 800px;
  margin: 3rem auto;
  padding: 0 1.5rem;
}

.bluesky-header {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
}

.bluesky-header h2 {
  margin: 0;
  font-size: 1.5rem;
}

.bluesky-header svg {
  width: 28px;
  height: 28px;
  fill: #0085ff;
}

.bluesky-loading {
  text-align: center;
  padding: 2rem;
  color: var(--secondary);
}

.bluesky-error {
  text-align: center;
  padding: 2rem;
  color: var(--secondary);
  font-size: 0.9rem;
}

.pinned-post {
  margin-bottom: 2rem;
}

.pinned-label {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  font-size: 0.8rem;
  font-weight: 600;
  color: var(--primary);
  margin-bottom: 0.75rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.pinned-label svg {
  width: 14px;
  height: 14px;
}

.post-card {
  background: var(--entry);
  border-radius: 12px;
  padding: 1.25rem;
  margin-bottom: 1rem;
  transition: box-shadow 0.2s ease;
}

.post-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.post-card.pinned {
  border: 2px solid var(--primary);
  background: rgba(8, 145, 178, 0.03);
}

.post-header {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  margin-bottom: 0.75rem;
}

.post-avatar {
  width: 42px;
  height: 42px;
  border-radius: 50%;
  object-fit: cover;
}

.post-author {
  flex: 1;
}

.post-author-name {
  font-weight: 600;
  font-size: 0.95rem;
  color: var(--primary);
}

.post-author-handle {
  font-size: 0.85rem;
  color: var(--secondary);
}

.post-date {
  font-size: 0.8rem;
  color: var(--secondary);
}

.post-content {
  font-size: 0.95rem;
  line-height: 1.6;
  margin-bottom: 0.75rem;
  white-space: pre-wrap;
  word-break: break-word;
}

.post-content a {
  color: var(--primary);
}

.post-images {
  display: grid;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  border-radius: 8px;
  overflow: hidden;
}

.post-images.single {
  grid-template-columns: 1fr;
}

.post-images.multiple {
  grid-template-columns: repeat(2, 1fr);
}

.post-images img {
  width: 100%;
  height: auto;
  max-height: 300px;
  object-fit: cover;
  border-radius: 8px;
}

.post-embed-card {
  display: block;
  border: 1px solid var(--border);
  border-radius: 8px;
  overflow: hidden;
  margin-bottom: 0.75rem;
  text-decoration: none;
  color: inherit;
}

.post-embed-card:hover {
  text-decoration: none;
}

.post-embed-card img {
  width: 100%;
  height: 150px;
  object-fit: cover;
}

.post-embed-card-content {
  padding: 0.75rem;
}

.post-embed-card-title {
  font-weight: 600;
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
}

.post-embed-card-description {
  font-size: 0.85rem;
  color: var(--secondary);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.post-stats {
  display: flex;
  gap: 1.25rem;
  font-size: 0.85rem;
  color: var(--secondary);
}

.post-stat {
  display: flex;
  align-items: center;
  gap: 0.3rem;
}

.post-stat svg {
  width: 16px;
  height: 16px;
}

.post-link {
  display: inline-block;
  margin-top: 0.5rem;
  font-size: 0.85rem;
  color: var(--primary);
}

.recent-posts-header {
  font-size: 1rem;
  font-weight: 600;
  color: var(--secondary);
  margin: 1.5rem 0 1rem 0;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.bluesky-footer {
  text-align: center;
  margin-top: 1.5rem;
}

.bluesky-follow-btn {
  display: inline-flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.6rem 1.25rem;
  background: #0085ff;
  color: #ffffff !important;
  border-radius: 20px;
  text-decoration: none;
  font-weight: 500;
  font-size: 0.9rem;
  transition: background 0.2s ease;
}

.bluesky-follow-btn:hover {
  background: #0066cc;
  text-decoration: none;
  color: #ffffff !important;
}

.bluesky-follow-btn svg {
  width: 18px;
  height: 18px;
  fill: white;
}
</style>

<div class="bluesky-header">
  <svg viewBox="0 0 600 530" xmlns="http://www.w3.org/2000/svg">
    <path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
  </svg>
  <h2>On Bluesky</h2>
</div>

<div id="bluesky-posts">
  <div class="bluesky-loading">Loading posts...</div>
</div>

<div class="bluesky-footer">
  <a href="https://bsky.app/profile/smcgrath.phd" target="_blank" class="bluesky-follow-btn">
    <svg viewBox="0 0 600 530" xmlns="http://www.w3.org/2000/svg">
      <path d="m135.72 44.03c66.496 49.921 138.02 151.14 164.28 205.46 26.262-54.316 97.782-155.54 164.28-205.46 47.98-36.021 125.72-63.892 125.72 24.795 0 17.712-10.155 148.79-16.111 170.07-20.703 73.984-96.144 92.854-163.25 81.433 117.3 19.964 147.14 86.092 82.697 152.22-122.39 125.59-175.91-31.511-189.63-71.766-2.514-7.3797-3.6904-10.832-3.7077-7.8964-0.0174-2.9357-1.1937 0.51669-3.7077 7.8964-13.714 40.255-67.233 197.36-189.63 71.766-64.444-66.128-34.605-132.26 82.697-152.22-67.108 11.421-142.55-7.4491-163.25-81.433-5.9562-21.282-16.111-152.36-16.111-170.07 0-88.687 77.742-60.816 125.72-24.795z"/>
    </svg>
    Follow @smcgrath.phd
  </a>
</div>

<script>
(function() {
  var HANDLE = 'smcgrath.phd';
  var API_BASE = 'https://public.api.bsky.app/xrpc';
  
  function fetchPosts() {
    return fetch(API_BASE + '/app.bsky.feed.getAuthorFeed?actor=' + HANDLE + '&limit=50&filter=posts_no_replies')
      .then(function(response) {
        if (!response.ok) throw new Error('Failed to fetch posts');
        return response.json();
      })
      .then(function(data) {
        return data.feed || [];
      })
      .catch(function(error) {
        console.error('Error fetching Bluesky posts:', error);
        return null;
      });
  }
  
  function isOriginalPost(item) {
    if (item.reason) return false;
    if (item.post.record.reply) return false;
    if (item.post.author.handle !== HANDLE) return false;
    return true;
  }
  
  function getEngagement(post) {
    return (post.likeCount || 0) + (post.repostCount || 0) + (post.replyCount || 0);
  }
  
  function isWithinDays(dateStr, days) {
    var postDate = new Date(dateStr);
    var now = new Date();
    var diffTime = now - postDate;
    var diffDays = diffTime / (1000 * 60 * 60 * 24);
    return diffDays <= days;
  }
  
  function formatDate(dateStr) {
    var date = new Date(dateStr);
    var now = new Date();
    var diffMs = now - date;
    var diffMins = Math.floor(diffMs / 60000);
    var diffHours = Math.floor(diffMs / 3600000);
    var diffDays = Math.floor(diffMs / 86400000);
    
    if (diffMins < 60) return diffMins + 'm';
    if (diffHours < 24) return diffHours + 'h';
    if (diffDays < 7) return diffDays + 'd';
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
  }
  
  function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }
  
  function linkifyText(text) {
    var escaped = escapeHtml(text);
    var urlRegex = /(https?:\/\/[^\s]+)/g;
    return escaped.replace(urlRegex, '<a href="$1" target="_blank" rel="noopener">$1</a>');
  }
  
  function getPostUrl(post) {
    var rkey = post.uri.split('/').pop();
    return 'https://bsky.app/profile/' + post.author.handle + '/post/' + rkey;
  }
  
  function renderPost(post, isPinned) {
    var images = (post.embed && post.embed.images) ? post.embed.images : [];
    var external = (post.embed && post.embed.external) ? post.embed.external : null;
    
    var imagesHtml = '';
    if (images.length > 0) {
      var gridClass = images.length === 1 ? 'single' : 'multiple';
      var imgTags = images.map(function(img) {
        return '<img src="' + img.thumb + '" alt="' + escapeHtml(img.alt || '') + '" loading="lazy">';
      }).join('');
      imagesHtml = '<div class="post-images ' + gridClass + '">' + imgTags + '</div>';
    }
    
    var embedHtml = '';
    if (external) {
      var thumbHtml = external.thumb ? '<img src="' + external.thumb + '" alt="">' : '';
      embedHtml = '<a href="' + external.uri + '" target="_blank" rel="noopener" class="post-embed-card">' +
        thumbHtml +
        '<div class="post-embed-card-content">' +
        '<div class="post-embed-card-title">' + escapeHtml(external.title || '') + '</div>' +
        '<div class="post-embed-card-description">' + escapeHtml(external.description || '') + '</div>' +
        '</div></a>';
    }
    
    var cardClass = isPinned ? 'post-card pinned' : 'post-card';
    
    return '<div class="' + cardClass + '">' +
      '<div class="post-header">' +
      '<img src="' + post.author.avatar + '" alt="" class="post-avatar">' +
      '<div class="post-author">' +
      '<div class="post-author-name">' + escapeHtml(post.author.displayName || post.author.handle) + '</div>' +
      '<div class="post-author-handle">@' + post.author.handle + '</div>' +
      '</div>' +
      '<div class="post-date">' + formatDate(post.record.createdAt) + '</div>' +
      '</div>' +
      '<div class="post-content">' + linkifyText(post.record.text || '') + '</div>' +
      imagesHtml +
      embedHtml +
      '<div class="post-stats">' +
      '<span class="post-stat"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg> ' + (post.likeCount || 0) + '</span>' +
      '<span class="post-stat"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg> ' + (post.repostCount || 0) + '</span>' +
      '<span class="post-stat"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg> ' + (post.replyCount || 0) + '</span>' +
      '</div>' +
      '<a href="' + getPostUrl(post) + '" target="_blank" rel="noopener" class="post-link">View on Bluesky →</a>' +
      '</div>';
  }
  
  function init() {
    var container = document.getElementById('bluesky-posts');
    
    fetchPosts().then(function(feedData) {
      if (!feedData) {
        container.innerHTML = '<div class="bluesky-error">Unable to load posts. <a href="https://bsky.app/profile/smcgrath.phd" target="_blank">View on Bluesky</a></div>';
        return;
      }
      
      var originalPosts = feedData
        .filter(isOriginalPost)
        .map(function(item) { return item.post; });
      
      if (originalPosts.length === 0) {
        container.innerHTML = '<div class="bluesky-error">No recent posts found.</div>';
        return;
      }
      
      var weekPosts = originalPosts.filter(function(p) { return isWithinDays(p.record.createdAt, 7); });
      var topPost = null;
      if (weekPosts.length > 0) {
        topPost = weekPosts.reduce(function(a, b) { return getEngagement(a) > getEngagement(b) ? a : b; });
      }
      
      var recentPosts = originalPosts
        .filter(function(p) { return !topPost || p.uri !== topPost.uri; })
        .slice(0, 5);
      
      var html = '';
      
      if (topPost && getEngagement(topPost) > 0) {
        html += '<div class="pinned-post">' +
          '<div class="pinned-label">' +
          '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"></path></svg>' +
          ' Top Post This Week</div>' +
          renderPost(topPost, true) +
          '</div>';
      }
      
      if (recentPosts.length > 0) {
        html += '<div class="recent-posts-header">Recent Posts</div>';
        for (var i = 0; i < recentPosts.length; i++) {
          html += renderPost(recentPosts[i], false);
        }
      }
      
      container.innerHTML = html;
    });
  }
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>

</div>
{{- end }}

{{- if not (.Param "hideFooter") }}
<footer class="footer">
    {{- if not site.Params.footer.hideCopyright }}
    {{- if site.Copyright }}
    <span>{{ site.Copyright | markdownify }}</span>
    {{- else }}
    <span>&copy; {{ now.Year }} {{ site.Title }}</span>
    {{- end }}
    {{- print " · "}}
    {{- end }}

    {{- with site.Params.footer.text }}
    {{ . | markdownify }}
    {{- print " · "}}
    {{- end }}    
    <span>
    Powered by 
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">hugo</a>, <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">papermod</a>, &amp;
        <a href="https://github.com/pmichaillat/hugo-website/" rel="noopener" target="_blank">hugo-website</a>.
    </span>
</footer>
{{- end }}

{{- if (not site.Params.disableScrollToTop) }}
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>
{{- end }}

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>

{{- if (not site.Params.disableScrollToTop) }}
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
{{- end }}

{{- if (not site.Params.disableThemeToggle) }}
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
{{- end }}

{{- if (and (eq .Kind "page") (ne .Layout "archives") (ne .Layout "search") (.Param "ShowCodeCopyButtons")) }}
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = '{{- i18n "code_copy" | default "copy" }}';

        function copyingDone() {
            copybutton.innerHTML = '{{- i18n "code_copied" | default "copied!" }}';
            setTimeout(() => {
                copybutton.innerHTML = '{{- i18n "code_copy" | default "copy" }}';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            // td containing LineNos
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            // table containing LineNos and code
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            // code blocks not having highlight as parent class
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
{{- end }}
